<!DOCTYPE html>
<html>
<head>
    {{template "template/css.html"}}
<style>
    .order-details {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
        font-family: 'Arial', sans-serif;
    }
    .order-details table {
        width: 100%;
        border-collapse: collapse;
    }
    .order-details th, .order-details td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .order-details th {
        color: #333;
        font-weight: bold;
    }
    .order-details td {
        color: #555;
    }
    .order-not-found {
        color: #d9534f;
        font-weight: bold;
        text-align: center;
        margin-top: 20px;
    }
    #merchantOrderId {
        max-width: 300px; /* 调整搜索框的长度 */
        display: inline-block; /* 使搜索框适应指定的宽度 */
    }
    .search-container {
        margin-bottom: 20px;
    }    
</style>


</head>
<body>
<div class="page">
    <!-- Main Navbar-->
    {{template "template/header.html"}}
    <div class="page-content d-flex align-items-stretch">
        <!-- Side Navbar -->
            <nav class="side-navbar">
                <!-- Sidebar Header-->
                <div class="sidebar-header d-flex align-items-center">
                    <a href="/index/ui/">
                        <div class="avatar">
                            <img src="../../static/img/avatar-1.jpg" alt="..." class="img-fluid rounded-circle">
                        </div>
                    </a>
                    <a href="#">
                        <div class="title">
                            <h1 class="h4">{{.userName}}</h1>
                            <p>欢迎您！</p>
                        </div>
                    </a>
                </div>
                <!-- Sidebar Navidation Menus-->
                <span class="heading">主菜单</span>
                <ul class="list-unstyled">
                    <li>
                        <a href="/index/ui/">
                            <i class="icon-home"></i>
                            首页
                        </a>
                    </li>
                    <li>
                        <a href="#exampledropdownDropdown" aria-expanded="false" data-toggle="collapse">
                            <i class="icon icon-user"></i>
                            账户管理
                        </a>
                        <ul id="exampledropdownDropdown" class="collapse list-unstyled ">
                            <li>
                                <a href="/user_info/show_modify_ui">修改密码</a>
                            </li>
                            <li>
                                <a href="/user_info/show_ui">账户资料</a>
                            </li>
                            <!--<li>-->
                            <!--    <a href="/index/show_pay_way_ui">通道配置</a>-->
                            <!--</li>-->
                        </ul>
                    </li>
                    <li>
                        <a href="#exampledropdownDropdown1" aria-expanded="true" data-toggle="collapse">
                            <i class="icon icon-presentation"></i>
                            订单管理
                        </a>
                        <ul id="exampledropdownDropdown1" class=" list-unstyled ">
                            <li class="active">
                                <a href="/query_order/ui">查询订单</a>
                            </li>
                            <li>
                                <a href="/trade/show_ui">订单记录</a>
                            </li>
                            <!--<li>-->
                            <!--    <a href="/trade/show_complaint_ui">投诉列表</a>-->
                            <!--</li>-->
                        </ul>
                    </li>
                    <li>
                        <a href="#exampledropdownDropdown2" aria-expanded="false" data-toggle="collapse">
                            <i class="icon icon-bill"></i>
                            财务管理
                        </a>
                        <ul id="exampledropdownDropdown2" class="collapse list-unstyled ">
                            <li>
                                <a href="/withdraw/show_ui">申请提现</a>
                            </li>
                            <!--<li>-->
                            <!--    <a href="/multi_withdraw/show_multi_ui">批量申请提现</a>-->
                            <!--</li>-->
                            <li>
                                <a href="/withdraw/show_list_ui">提现记录</a>
                            </li>
                            <!--{{/*-->
                            <!--<li>-->
                            <!--    <a href="/recharge/show_recharge_list_ui">自定义记录</a>-->
                            <!--</li>-->
                            <!--*/}}-->
                            <!--<li>-->
                            <!--    <a href="/history/show_history_list_ui">资产变动明细</a>-->
                            <!--</li>-->
                        </ul>
                    </li>
                    <li>
                      <a href="/api_docs/apidoc.pdf" target="_blank">
                        <i class="icon icon-interface-windows"></i>
                        API文档
                      </a>
                    </li>
                </ul>
            </nav>
        <div class="content-inner">
            <!-- Page Header-->
            <header class="page-header">
                <div class="container-fluid">
                    <h2 class="no-margin-bottom">查询订单 - 请输入商户订单号，点击搜索查询</h2>
                </div>
            </header>
            <!-- Forms Section-->
            <section class="forms">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                            <div class="card-header d-flex align-items-center search-container">
                                <input type="text" id="merchantOrderId" placeholder="商户订单号" class="form-control mr-3" onkeypress="handleKeyPress(event)">
                                
                                <!-- 在 query_order.html 中添加，使用相同的类和宽度设置 -->
                                <label for="transactionType">交易类型:</label>
                                <select id="transactionType" name="transactionType" class="form-control" style="max-width: 100px;">
                                    <option value="collect">代收</option>
                                    <option value="disburse">代付</option>
                                </select>
                                
                                                                
                                <button onclick="searchOrder()" class="btn btn-primary" style="margin-left: 15px;">搜索</button>
                                <!-- 在查询按钮后添加 -->
                                <!--<button id="generateReceiptBtn" class="btn btn-secondary" style="margin-left: 15px;" disabled onclick="generateReceipt()">生成回单</button>-->

                            </div>
                                <div class="card-body">
                                    <div id="orderResult"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- 回单模板 -->
<div id="receiptTemplate" style="display:none;">
    <div class="receipt-container">
        <div class="receipt-header">
            <h2>付款回单</h2>
        </div>
        <div class="receipt-section">
            <strong>订单号：</strong> <span id="receiptOrderId"></span><br>
            <strong>金额：</strong> <span id="receiptAmount"></span><br>
            <strong>付款日期：</strong> <span id="receiptDate"></span><br>
            <!-- 添加更多需要的字段 -->
        </div>
        <div class="receipt-footer">
            <p>感谢您使用我们的服务！</p>
        </div>
    </div>
</div>

<!-- JavaScript files-->
{{template "template/js.html"}}
<script>
function searchOrder() {
    var merchantOrderId = document.getElementById('merchantOrderId').value;
    var transactionType = document.getElementById('transactionType').value; // 获取交易类型的值

    if (!merchantOrderId) {
        alert('请输入商户订单号');
        return;
    }

    // 修改API URL以包含交易类型参数
    var apiUrl = '/query_order/search?merchantOrderId=' + merchantOrderId + '&transactionType=' + transactionType;

    fetch(apiUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        displayOrderData(data,transactionType);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('orderResult').innerHTML = '<p class="order-not-found">未找到订单</p>';
    });
    
    // 查询成功后
    document.getElementById('generateReceiptBtn').disabled = false;
    document.getElementById('generateReceiptBtn').classList.remove('btn-secondary');
    document.getElementById('generateReceiptBtn').classList.add('btn-primary');

}



function displayOrderData(orderData,transactionType) {
    // 检查是否存在订单号
    if (!orderData.ref_trade_id) {
        document.getElementById('orderResult').innerHTML = '<p class="order-not-found">未找到订单</p>';
        return;
    }

    // 检查 customer 字段是否存在并且包含所需的属性
    var customerName = '未知';
    if (orderData.customer && 'first_name' in orderData.customer && 'last_name' in orderData.customer) {
        customerName = orderData.customer.first_name + ' ' + orderData.customer.last_name;
    }

    // 构建订单详情的 HTML 结构
    var orderDetails = `
        <div class="order-details">
            <table>
                <tr><th>订单号 (Order ID):</th><td>${orderData.ref_trade_id}</td></tr>
                <tr><th>金额 (Amount):</th><td>${orderData.amount} ${orderData.currency}</td></tr>
                <tr><th>手续费 (Fee):</th><td>${orderData.fee_amount}</td></tr>
                <tr><th>状态 (Status):</th><td>${orderData.status}</td></tr>
                <tr><th>客户姓名 (Customer Name):</th><td>${customerName}</td></tr>
                <tr><th>交易时间 (Transaction Time):</th><td>${new Date(parseInt(orderData.trans_at)).toLocaleString()}</td></tr>
                <tr><th>描述 (Description):</th><td>${orderData.description}</td></tr>
            </table>
        </div>
    `;


    // 根据订单类型构建不同的HTML结构
    var orderDetailsHtml;
    if (transactionType === "collect") {
        var customerName = '未知';
        if (orderData.customer && 'first_name' in orderData.customer && 'last_name' in orderData.customer) {
            customerName = orderData.customer.first_name + ' ' + orderData.customer.last_name;
        }
        // 代收订单的HTML结构
        orderDetailsHtml = `
            <!-- 代收订单的详细信息 -->
            <div class="order-details">
                <table>
                    <tr><th>订单号 (Order ID):</th><td>${orderData.ref_trade_id}</td></tr>
                    <tr><th>金额 (Amount):</th><td>${orderData.amount} ${orderData.currency}</td></tr>
                    <tr><th>手续费 (Fee):</th><td>${orderData.fee_amount}</td></tr>
                    <tr><th>状态 (Status):</th><td>${orderData.status}</td></tr>
                    <tr><th>客户姓名 (Customer Name):</th><td>${customerName}</td></tr>
                    <tr><th>交易时间 (Transaction Time):</th><td>${new Date(parseInt(orderData.trans_at)).toLocaleString()}</td></tr>
                    <tr><th>描述 (Description):</th><td>${orderData.description}</td></tr>
                </table>
            </div>
        `;
    } else if (transactionType === "disburse") {
        // 代付订单的HTML结构
        orderDetailsHtml = `
            <div class="order-details">
                <table>
                    <tr><th>订单号 (Ref Trade ID):</th><td>${orderData.ref_trade_id}</td></tr>
                    <tr><th>金额 (Amount):</th><td>${orderData.amount} ${orderData.currency}</td></tr>
                    <tr><th>状态 (Status):</th><td>${orderData.status}</td></tr>
                    <tr><th>银行账户名 (Bank Account Name):</th><td>${orderData.bank_account_name}</td></tr>
                    <tr><th>银行账号 (Bank Account No):</th><td>${orderData.bank_account_no}</td></tr>
                    <tr><th>失败原因 (Fail Reason):</th><td>${orderData.fail_reason || '无'}</td></tr>
                    <tr><th>交易时间 (Transaction Time):</th><td>${new Date(parseInt(orderData.trans_at)).toLocaleString()}</td></tr>
                    <tr><th>描述 (Description):</th><td>${orderData.description || '无'}</td></tr>
                </table>
            </div>
        `;
    } else {
        // 未知订单类型的处理
        orderDetailsHtml = '<p class="order-not-found">未知的订单类型</p>';
    }

    // 将构建的 HTML 显示在页面上
    document.getElementById('orderResult').innerHTML = orderDetailsHtml;
    
    // 添加隐藏元素以存储订单ID和金额
    var hiddenDetails = `
        <div style="display: none;">
            <span id="hiddenOrderId">${orderData.ref_trade_id}</span>
            <span id="hiddenOrderAmount">${orderData.amount} ${orderData.currency}</span>
        </div>
    `;
    document.getElementById('orderResult').innerHTML += hiddenDetails;
    console.log("Hidden Order ID: " + document.getElementById('hiddenOrderId').innerText);
    console.log("Hidden Order Amount: " + document.getElementById('hiddenOrderAmount').innerText);
}

function handleKeyPress(event) {
    if (event.keyCode === 13) { // 13 是回车键的键码
        searchOrder();
    }
}

function generateReceipt() {
    var transactionType = document.getElementById('transactionType').value;
    var orderId = document.getElementById('hiddenOrderId').innerText;
    var amount = document.getElementById('hiddenOrderAmount').innerText;
    var date = new Date().toLocaleDateString();

    // 获取回单模板
    var receiptTemplate = document.getElementById('receiptTemplate').innerHTML;

    // 根据交易类型动态生成回单内容
    var receiptContent;
    if (transactionType === 'collect') {
        // 代收的回单内容
        receiptContent = `
            <strong>订单号：</strong> ${orderId}<br>
            <strong>金额：</strong> ${amount}<br>
            <strong>付款日期：</strong> ${date}<br>
            <!-- ... 其他代收回单信息 ... -->
        `;
    } else if (transactionType === 'disburse') {
        // 代付的回单内容
        receiptContent = `
            <strong>订单号：</strong> ${orderId}<br>
            <strong>金额：</strong> ${amount}<br>
            <strong>付款日期：</strong> ${date}<br>
            <!-- ... 其他代付回单信息 ... -->
        `;
    }

    // 创建一个新的 div 元素来显示回单
    var receiptDiv = document.createElement('div');
    receiptDiv.innerHTML = receiptTemplate;
    receiptDiv.querySelector('.receipt-section').innerHTML = receiptContent; // 设置回单内容

    // 添加下载和返回按钮
    var buttonsHtml = `
        <button onclick="downloadReceipt()" class="btn btn-primary">下载</button>
        <button onclick="closeReceipt()" class="btn btn-secondary">返回</button>
    `;
    receiptDiv.querySelector('.receipt-footer').innerHTML += buttonsHtml;

    // 添加样式以确保回单是可见的
    applyReceiptStyles(receiptDiv);

    document.body.appendChild(receiptDiv);
}

// 添加下载回单的功能
function downloadReceipt() {
    // ... 实现下载功能的代码 ...
    alert('下载功能尚未实现。');
}

// 关闭回单显示
function closeReceipt() {
    var receiptDiv = document.querySelector('.receipt-container');
    document.body.removeChild(receiptDiv);
}

// 应用回单样式
function applyReceiptStyles(receiptDiv) {
    receiptDiv.style.position = "fixed";
    receiptDiv.style.top = "50px";
    receiptDiv.style.left = "50px";
    receiptDiv.style.backgroundColor = "white";
    receiptDiv.style.border = "1px solid black";
    receiptDiv.style.padding = "20px";
    receiptDiv.style.zIndex = "1000"; // 确保在最上层
}

// 你可能还需要为按钮添加相应的样式，这取决于你的页面上已有的样式表



</script>
</body>
</html>